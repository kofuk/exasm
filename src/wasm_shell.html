<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>exasm</title>
    <meta name="viewport" content="width=device-width"/>
  </head>
  <body>
    <div>
      <a href="https://github.com/kofuk/exasm">View source code</a>
    </div>

    <div style="background-color: yellow" id="err"></div>

    <div>
      <form>
        <textarea id="src" rows="20" cols="20" placeholder="Write assembly source code here..."></textarea><br/>
        <input id="run_asm" type="submit" value="Assemble" />
      </form>
    </div>

    <div>
      Output:
      <pre style="background-color: #ccc"><code id="output"></code></pre>
    </div>

    <script>
     var Module = {
         preRun: [],
         postRun: [],
         print: function(text) {
             console.log(text);
         },
         printErr: function(text) {
             if (text.match(/^program exited/)) {
                 console.log(text);
                 return;
             }
             document.getElementById('err').innerText += text + '\n';
         },
         setStatus: function(text) {
             if (text) console.log(text);
         },
     };

     addEventListener('load', () => {
         document.getElementById('run_asm')
                 .addEventListener('click', (e) => {
                     e.preventDefault();
                     document.getElementById('err').innerText = '';

                     const src = document.getElementById('src').value;
                     const encoder = new TextEncoder();
                     const data = encoder.encode(src);
                     const offset = Module._malloc(src.length);
                     for (let i = 0; i < data.length; i++) {
                         Module.HEAPU8[i + offset] = data[i];
                     }
                     const result = Module.ccall('asm_byte_array', 'string',
                                                 ['number', 'number'],
                                                 [offset, src.length]);
                     document.getElementById('output').innerText = result;
                     Module._free(offset);
                 });
     });
    </script>
    {{{ SCRIPT }}}
  </body>
</html>
