<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>webemu</title>
    <meta name="viewport" content="width=device-width"/>
    <style>
     @keyframes blink {
         from {
             background-color: yellow;
         }
         to {
             background-color: transparent;
         }
     }

     .blinking {
         animation-name: blink;
         animation-duration: 600ms;
         animation-iteration-count: infinite;
         animation-direction: alternate;
     }

     .break {
         background-color: red !important;
     }
    </style>
  </head>
  <body style="font-family:monospace">
    <div style="position:sticky; left:0; top:0; background:lightblue; border-bottom:2px solid black; padding:8px">
      <input type="button" value="Load mem and program" id="prog_init" />
      Memory: <input type="text" size="3" id="mem_start" value="0x34" />--<input type="text" size="3" id="mem_end" value="0x40" /><input type="button" value="Set range" id="set_range" />
      <input type="button" value="Next clock (→)" id="clock" />
      <div style="background-color: yellow" id="err"></div>
    </div>

    <div style="display:flex">
      <div style="flex:1">
        <form>
          <textarea id="prog" rows="15" cols="20" placeholder="Program (assembly)"></textarea><br/>
          <textarea id="memfile" rows="15" cols="20" placeholder="Contents of .mem file"></textarea><br/>
        </form>
        <div>
          <a href="https://github.com/kofuk/exasm">View source code on GitHub</a>
        </div>
      </div>
      <div style="flex:2">
        <div id="status" style="background:lightgreen"></div>

        <div>
          Executed address: <input type="text" id="exec_addr" />
        </div>

        <div>
          Register:
          <table border="1">
            <thead>
              <tr>
                <th>r0</th>
                <th>r1</th>
                <th>r2</th>
                <th>r3</th>
                <th>r4</th>
                <th>r5</th>
                <th>r6</th>
                <th>r7</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input type="text" size="3" id="reg0" /></td>
                <td><input type="text" size="3" id="reg1" /></td>
                <td><input type="text" size="3" id="reg2" /></td>
                <td><input type="text" size="3" id="reg3" /></td>
                <td><input type="text" size="3" id="reg4" /></td>
                <td><input type="text" size="3" id="reg5" /></td>
                <td><input type="text" size="3" id="reg6" /></td>
                <td><input type="text" size="3" id="reg7" /></td>
              </tr>
            </tbody>
          </table>
          <input type="button" value="Apply changes" id="apply_reg" />
        </div>

        <div>
          Memory:
          <table border="1">
            <thead>
              <tr>
                <th></th>
                <th>x0</th>
                <th>x1</th>
                <th>x2</th>
                <th>x3</th>
                <th>x4</th>
                <th>x5</th>
                <th>x6</th>
                <th>x7</th>
              </tr>
            </thead>
            <tbody id="mem_table_body">
            </tbody>
          </table>
          <input type="button" value="Apply changes" id="apply_mem" />
        </div>

        <div>
          Trace:
          <table border="1" style="display:block; max-height:350px; overflow: auto">
            <thead>
              <tr>
                <th>Break</th>
                <th>Instruction</th>
              </tr>
            </thead>
            <tbody id="trace_body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
     var Module = {
         preRun: [],
         postRun: [],
         print: function(text) {
             console.log(text);
         },
         printErr: function(text) {
             if (text.match(/^program exited/)) {
                 console.log(text);
                 return;
             }
             showError(text);
         },
         setStatus: function(text) {
             if (text) console.log(text);
         },
     };

     let emulator = 0;

     const showError = (text) => {
         document.getElementById('err').innerText = text;
     };

     const showStatus = (text) => {
         document.getElementById('status').innerText = text;
     };

     const updateEmulatorStatus = () => {
         if (emulator === 0) {
             return;
         }

         for (let i = 0; i < 8; i++) {
             const val = Module.ccall('get_register_value', 'number', ['number', 'number'],
                                      [emulator, i]);
             const el = document.getElementById('reg' + i);
             el.parentNode.classList.remove('blinking');
             if (parseInt(el.value) != val) {
                 el.parentNode.classList.add('blinking');
             }
             el.value = '0x' + val.toString(16);
         }
         const memOffset = Module.ccall('get_memory', 'number', ['number'], [emulator]);
         for (let i = memStart; i < memEnd; ++i) {
             const el = document.getElementById('mem' + i);
             el.parentNode.classList.remove('blinking');
             if (parseInt(el.value) != Module.HEAPU8[memOffset + i]) {
                 el.parentNode.classList.add('blinking');
             }
             el.value = '0x' + Module.HEAPU8[memOffset + i].toString(16);
         }
     };

     let memStart = 0;
     let memEnd = 0;

     const createMemTable = () => {
         let start = parseInt(document.getElementById('mem_start').value);
         let end = parseInt(document.getElementById('mem_end').value);
         if (isNaN(start) || isNaN(end) || (end < start)) {
             return;
         }
         start &= ~0x7;
         if ((end & 0x7) != 0) {
             end += 8 - end & 0x7;
         }

         document.getElementById('mem_start').value = '0x' + start.toString(16);
         document.getElementById('mem_end').value = '0x' + end.toString(16);

         if (start == memStart && end == memEnd) {
             return;
         }

         memStart = start;
         memEnd = end;

         const tableBody = document.getElementById('mem_table_body');
         tableBody.innerHTML = '';

         let tr;
         for (let i = start; i < end; ++i) {
             if (i % 8 == 0) {
                 tr = document.createElement('tr');
                 const td = document.createElement('td');
                 td.innerText = i.toString(16) + '-' + (i + 7).toString(16);
                 tr.appendChild(td);
             }
             const td = document.createElement('td');
             const input = document.createElement('input');
             input.type = 'text';
             input.size = 3;
             input.id = 'mem' + i;
             td.appendChild(input);
             tr.appendChild(td);

             if (i % 8 == 7) {
                 tableBody.appendChild(tr);
             }
         }
     };

     const blinkCurrentLine = (addr) => {
         const progLines = document.getElementById('trace_body').children;
         for (let i = 0; i < progLines.length; i++) {
             progLines[i].classList.remove('blinking', 'break');
         }
         const el = document.getElementById('prog' + addr);
         el.classList.add('blinking')
         el.scrollIntoView({
             behavior: 'smooth',
             block: 'nearest',
         });
     };

     const createTraceTable = () => {
         if (emulator === 0) {
             return;
         }

         const prog = Module.ccall('dump_program', 'string', ['number'],
                                   [emulator]);

         const traceBody = document.getElementById('trace_body');
         traceBody.innerHTML = '';
         let addr = 0;
         prog.split('\n')
             .forEach(e => {
                 if (e.length === 0) return;
                 const tr = document.createElement('tr');
                 tr.id = 'prog' + addr;
                 const td1 = document.createElement('td');
                 const checkBox = document.createElement('input');
                 checkBox.type = 'checkbox';
                 checkBox.id = 'break' + addr;
                 checkBox.addEventListener('change', e => {
                     const addr = parseInt(e.target.id.replace('break', ''));
                     if (isNaN(addr)) {
                         return;
                     }
                     if (e.target.checked) {
                         Module.ccall('set_breakpoint', 'number', ['number', 'number'],
                                      [emulator, addr]);
                     } else {
                         Module.ccall('remove_breakpoint', 'number', ['number', 'number'],
                                      [emulator, addr]);
                     }
                 });
                 td1.appendChild(checkBox);
                 tr.appendChild(td1);
                 const td2 = document.createElement('td');
                 td2.innerText = e;
                 tr.appendChild(td2);
                 traceBody.appendChild(tr);
                 addr += 2;
             });
     };

     const putStringToHeap = (str) => {
         const encoder = new TextEncoder();
         const data = encoder.encode(str);
         const offset = Module._malloc(data.length);
         for (let i = 0; i < data.length; i++) {
             Module.HEAPU8[i + offset] = data[i];
         }
         return [offset, data.length];
     };

     let breaked = false;

     const clock = () => {
         if (emulator === 0) {
             showError('Program not loaded');
             return;
         }

         showError('');

         const addr = Module.ccall('next_clock', 'number', ['number'], [emulator]);
         const breakAddr = Module.ccall('get_hit_breakpoint', 'number', [], []);
         if (breakAddr >= 0) {
             blinkCurrentLine(breakAddr);
             document.getElementById('break' + breakAddr).parentNode.parentNode
                     .classList.add('break');
             breaked = true;
             document.getElementById('clock').value = 'Continue';
         } else {
             blinkCurrentLine(addr);
             document.getElementById('exec_addr').value = '0x' + addr.toString(16);
         }

         updateEmulatorStatus();
     };

     addEventListener('load', () => {
         document.getElementById('prog_init')
                 .addEventListener('click', () => {
                     if (emulator !== 0) {
                         Module._free(emulator);
                         emulator = 0;
                     }

                     showError('');

                     const memdata = putStringToHeap(document.getElementById('memfile').value);
                     const progdata = putStringToHeap(document.getElementById('prog').value);

                     emulator = Module.ccall('init_emulator', 'number',
                                             ['number', 'number', 'number', 'numer'],
                                             [memdata[0], memdata[1], progdata[0], progdata[1]]);

                     Module._free(memdata[0]);
                     Module._free(progdata[0]);

                     createTraceTable();

                     showStatus('Ready');
                     updateEmulatorStatus();
                 });
         document.getElementById('set_range')
                 .addEventListener('click', () => {
                     createMemTable();
                     updateEmulatorStatus();
                 });
         document.getElementById('clock')
                 .addEventListener('click', e => {
                     breaked = false;
                     e.target.value = 'Next clock (→)';
                     clock();
                 });
         document.getElementById('apply_reg')
                 .addEventListener('click', () => {
                     if (emulator === 0) {
                         return;
                     }

                     for (let i = 0; i < 8; i++) {
                         const val = parseInt(document.getElementById('reg' + i).value);
                         if (isNaN(val)) {
                             continue;
                         }

                         Module.ccall('set_register_value', 'number',
                                      ['number', 'number', 'number'],
                                      [emulator, i, val]);
                     }
                     updateEmulatorStatus();
                 });
         document.getElementById('apply_mem')
                 .addEventListener('click', () => {
                     if (emulator === 0) {
                         return;
                     }

                     const dataTmp = Module._malloc(memEnd - memStart);
                     for (let i = 0; i < memEnd - memStart; i++) {
                         const val = parseInt(document.getElementById('mem' + (i + memStart)).value);
                         if (isNaN(val)) {
                             continue;
                         }

                         Module.HEAPU8[dataTmp + i] = val;
                     }

                     Module.ccall('set_mem_value', 'number',
                                  ['number', 'number', 'number', 'number'],
                                  [emulator, dataTmp, memEnd - memStart, memStart]);
                     Module._free(dataTmp);
                     updateEmulatorStatus();
                 });

         createMemTable();
     });

     document.body.addEventListener('keydown', e => {
         if (breaked) {
             return;
         }
         if (e.key === 'ArrowRight') {
             clock();
         }
     });
    </script>
    <script
	    src="https://code.jquery.com/jquery-3.6.0.slim.min.js"
		integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI="
		crossorigin="anonymous"></script>
    <script>
     /************************************************
      * #### jQuery bcralnit.js v0.0.1 ####
      * add line number in textarea, pre, div etc.
      * Coded by Ican Bachors 2017.
      * https://github.com/bachors/bcralnit.js
      * Updates will be posted to this site.
      ***********************************************/

     $.fn.bcralnit = function(e) {
         var f = {
             width: '60px',
             background: '#ddd',
             color: '#333',
             addClass: ''
         };
         if (typeof e === 'object') {
             e.width = (e.width == undefined ? f.width : e.width);
             e.background = (e.background == undefined ? f.background : e.background);
             e.color = (e.color == undefined ? f.color : e.color);
             e.addClass = (e.addClass == undefined ? f.addClass : e.addClass)
         } else {
             e = f
         }
         $(this).each(function(i, a) {
             var f = $(this)[0].tagName,
			     kk = (f == 'TEXTAREA' ? $(this).val() : $(this).text()),
                 w = $(this).css('width'),
                 h = $(this).css('height'),
                 d = ($(this).css('display') == 'inline' ? 'inline-block' : $(this).css('display')),
                 ff = $(this).css('font-family'),
                 fs = $(this).css('font-size'),
                 fw = $(this).css('font-weight'),
                 lh = $(this).css('line-height'),
                 bt = $(this).css('border-top-width'),
                 bb = $(this).css('border-bottom-width'),
                 br = $(this).css('border-right-width'),
                 bl = $(this).css('border-left-width'),
                 m = $(this).css('margin'),
                 pt = $(this).css('padding-top'),
                 pb = $(this).css('padding-bottom'),
                 pl = $(this).css('padding-left'),
                 pr = $(this).css('padding-right'),
                 nw = (parseInt(w) - parseInt(e.width)) + 'px',
                 c = ($(this).attr('id') != null && $(this).attr('id') != undefined ? 'bcralnit_' + $(this).attr('id') + i : 'bcralnit_' + $(this).attr('class') + i),
                 b = '<div class="bcr_number" style="text-shadow:none;position:absolute;box-sizing:border-box;border:none;margin:0px;overflow-x:hidden;overflow-y:auto;white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;padding:' + (parseInt(pt) + parseInt(bt)) + 'px ' + pr + ' ' + pb + ' ' + pl + ';font-family:' + ff + ';font-size:' + fs + ';font-weight:' + fw + ';line-height:' + lh + ';right:' + e.width + ';width:' + (parseInt(nw) - parseInt(br) - parseInt(bl)) + 'px;height:calc(100% - ' + bb + ');background:' + e.background + ';color:' + e.background + '"></div>';
		     if(e.addClass != ''){
			     $(this).addClass(e.addClass);
		     }
             $(this).css('width', nw);
             $(this).css('height', '100%');
             $(this).css('position', 'absolute');
             $(this).css('overflow-x', 'hidden');
             $(this).css('overflow-y', 'auto');
             $(this).css('resize', 'none');
             $(this).css('top', '0px');
             $(this).css('margin', '0px');
             $(this).css('box-shadow', 'none');
             $(this).css('left', e.width);
             $(this).css('box-sizing', 'border-box');
             $(this).css('white-space', 'pre-wrap');
             $(this).css('white-space', 'moz-pre-wrap');
             $(this).css('white-space', '-pre-wrap');
             $(this).css('white-space', '-o-pre-wrap');
             $(this).css('word-wrap', 'break-word');
             $(this).addClass("bcr_line");
             $(this).wrap('<div id="' + c + '" style="display:' + d + ';overflow:hidden;box-sizing:border-box;border:none;background:' + e.background + ';position:relative;padding:0px;margin:' + m + ';width:' + w + ';height:' + h + '"></div>');
             $(this).before(b);
             addln(c, kk);
             $(this).on('blur focus change keyup keydown', function() {
			     if(f == 'TEXTAREA'){
				     var vv = $(this).val();
				     addln(c, vv);
			     }
             });
             $(this).scroll(function() {
                 $('#' + c + ' .bcr_number').scrollTop($(this).scrollTop())
             })
         });

         function addln(b, vv) {
             var a = vv.split(/\n/),
			     c = '';
             for (i = 0; i < a.length; i++) {
                 var n = (i + 1);
                 var f = a[i];
                 var g = f.substring(n.toString().length, f.length);
                 c += '<span style="background:transparent;border:none;box-shadow:none;color:' + e.color + '">' + n + '</span>' + g.replace(/\</ig, '~').replace(/\>/ig, '~') + '<br>'
             };
             $('#' + b + ' .bcr_number').html(c);
             $('#' + b + ' .bcr_number').scrollTop($('#' + b + ' .bcr_line').scrollTop());
         }
     }
    </script>
    <script>
     $('#prog').bcralnit();
    </script>
    {{{ SCRIPT }}}
  </body>
</html>
